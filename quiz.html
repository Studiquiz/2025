<!-- quiz.html -->
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Uni Quiz</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container">
    <div id="frageContainer"></div>

    <div class="navigation">
      <button id="zurueck">Back</button>
      <button id="weiter">Continue</button>
      <button id="abschliessen" class="hidden">Finish</button>
    </div>

    <div id="dankeContainer" class="hidden">
      <h2>Thank you for participating!</h2>

      <p>
        This "quiz" was <strong>not only intended to assess the content of your answers,</strong>
        but was part of a scientific study on behavior when dealing with legal notices,
        in particular the <strong>privacy policy</strong> and the <strong>terms and conditions</strong>.
      </p>

      <p>The actual research question of the study was:</p>
      <ul>
      <li>whether and for how long the privacy policy and terms and conditions were read,</li>
      <li>which content was observed or skipped,</li>
      <li>and whether consent was given consciously.</li>
      </ul>

      <p>Additionally, the study aimed to examine the extent to which participants' self-reported behavior matched their actual behavior during the quiz.</p>
      
      <p>
      For methodological reasons, this objective was not initially communicated openly.
      We would therefore like to fully inform you now.
      </p>
      
      <p>
      Participation in this study is voluntary.
      You can withdraw at any time without giving a reason.
      In this case, <strong>you do not need to upload the CSV file</strong>.
      </p>
      
      <p>
        If you <strong>agree with the evaluation</strong>, you can now download the file here. Thank you very much!
      </p>

      <button id="csvDownloadBtn">CSV Download</button>
      <!-- hier muss noch die Website hin, evtl Qualtrics oder so, aber unsicher, ob geht, weil nur noch 1 acc -->
      <p>
        You can upload the CSV file on the following page:<br>
        <a href="https://ecampus.uni-bonn.de/ilias.php?baseClass=ilexercisehandlergui&cmdNode=cn:nq&cmdClass=ilObjExerciseGUI&cmd=showOverview&ref_id=3808197" target="_blank" rel="noopener">
          ➜ upload page (tbd) 
        </a>
      </p>
      
    </div>
  </div>

  <script>
    const fragen = [
      {
        frage: "If you own a PC/Laptop: What OS(Operating System) do you primarily use?",
        antworten: null,
        mehrfach: false,
        typ: "text"
      },
      {
        frage: "How would you estimate your technical affinity?",
        antworten: ["Very high (I program regularly and am well-versed in systems)", "High (I have basic knowledge and interest in technology)", "Medium (I use technology but without in-depth knowledge)", "Low (I use technology only when necessary)"],
        mehrfach: false
      },
      {
        frage: "How did you gain your technical experience? (Multiple selection possible)",
        antworten: ["Work (technical field)", "Work (not in a technical field)", "Hobbies", "Media", "None of the above."],
        mehrfach: true
      },
      {
        frage: "Have you already worked or studied in one of these subject areas: engineering, computer science, data science, maths, physics",
        antworten: ["Yes", "No", "No answer"],
        mehrfach: false
      },
      { 
        frage: "In the following, a number of statements concerning personal attitudes and traits is listed. Read each item and decide if it is true or false: If I knew I wouldn’t get caught, I would use pirated software",
        antworten: ["True", "False"],
        mehrfach: false
      },
      {
        frage: "If I knew I wouldn’t get caught, I would watch movies illegally)",
        antworten: ["True", "False"],
        mehrfach: false
      },
      {
        frage: "I only use secure passwords (passwords that are long and complex)",
        antworten: ["True", "False"],
        mehrfach: false
      },
      {
        frage: "I never reuse passwords (I use different passwords for all my accounts)",
        antworten: ["True", "False"],
        mehrfach: false
      },
      {
        frage: "I always encrypt e-mails containing personal data",
        antworten: ["True", "False"],
        mehrfach: false
      },
      {
        frage: "I am always aware of what personal data is collected by the platforms I use and how it is used",
        antworten: ["True", "False"],
        mehrfach: false
      },
      {
        frage: "I always read the privacy policy before giving an app/application access to my personal data",
        antworten: ["True", "False"],
        mehrfach: false
      },
      {
        frage: "I always read the privacy policy completely before I agree to them",
        antworten: ["True", "False"],
        mehrfach: false
      },
      {
        frage: "I always read the terms and conditions completely before I agree to them",
        antworten: ["True", "False"],
        mehrfach: false
      },
      {
        frage: "I am always just as polite online as I am in the real world",
        antworten: ["True", "False"],
        mehrfach: false
      },
      {
        frage: "There have been occasions when I felt like smashing a computer",
        antworten: ["True", "False"],
        mehrfach: false
      },
      {
        frage: "I am never annoyed if people ask me to help them with their computers",
        antworten: ["True", "False"],
        mehrfach: false
      },
      {
        frage: "I have never considered posting a troll-comment",
        antworten: ["True", "False"],
        mehrfach: false
      },
      {
        frage: "I have never read somebody else’s messages without explicit permission",
        antworten: ["True", "False"],
        mehrfach: false
      },
      {
        frage: "I have never looked at someone else’s screen without their permission",
        antworten: ["True", "False"],
        mehrfach: false
      },
      {
        frage: "I never ignore security warnings on my computer",
        antworten: ["True", "False"],
        mehrfach: false
      },
      {
        frage: "I never ignore software update reminders",
        antworten: ["True", "False"],
        mehrfach: false
      }
    ];

    let aktuelleFrage = 0;
    const frageContainer = document.getElementById("frageContainer");
    const zurueck = document.getElementById("zurueck");
    const weiter = document.getElementById("weiter");
    const abschliessen = document.getElementById("abschliessen");
    const dankeContainer = document.getElementById("dankeContainer");

    let daten = JSON.parse(localStorage.getItem("uniQuizDaten")) || {};
    const pseudonym = daten.kuerzel || "Kein Pseudonym gefunden";
    if (!daten.quizAntworten) daten.quizAntworten = [];

function zeigeFrage() {
  const f = fragen[aktuelleFrage];

  if (aktuelleFrage === 0) {
    frageContainer.innerHTML = `
      <p><strong>${f.frage}</strong></p>
      <p>Frage 1 von ${fragen.length}</p>
      <input type="text" id="freitextAntwort" maxlength="30" placeholder="Antwort eingeben..." style="width: 100%; padding: 0.5em;" />
    `;

    const vorherigeAntwort = daten.quizAntworten[0];
    if (vorherigeAntwort) {
      document.getElementById("freitextAntwort").value = vorherigeAntwort;
    }
  } else {
    frageContainer.innerHTML = `
      <p><strong>${f.frage}</strong></p>
      <p>Frage ${aktuelleFrage + 1} von ${fragen.length}</p>
      ` +
      f.antworten.map((antwort, i) => `
        <div><input type="${f.mehrfach ? 'checkbox' : 'radio'}" name="antwort" id="a${i}" value="${antwort}">
        <label for="a${i}">${antwort}</label></div>
      `).join('');

    const vorherigeAntwort = daten.quizAntworten[aktuelleFrage];
    if (vorherigeAntwort) {
      if (Array.isArray(vorherigeAntwort)) {
        vorherigeAntwort.forEach(a => {
          const input = document.querySelector(`input[value='${a}']`);
          if (input) input.checked = true;
        });
      } else {
        const input = document.querySelector(`input[value='${vorherigeAntwort}']`);
        if (input) input.checked = true;
      }
    }
  }

  zurueck.disabled = aktuelleFrage === 0;
  weiter.classList.toggle("hidden", aktuelleFrage === fragen.length - 1);
  abschliessen.classList.toggle("hidden", aktuelleFrage !== fragen.length - 1);
}

function speichereAntwort() {
  const f = fragen[aktuelleFrage];
  let antwort;

  if (aktuelleFrage === 0) {
    antwort = document.getElementById("freitextAntwort").value.trim();
  } else if (f.mehrfach) {
    antwort = Array.from(document.querySelectorAll("input[name='antwort']:checked")).map(i => i.value);
  } else {
    const selected = document.querySelector("input[name='antwort']:checked");
    antwort = selected ? selected.value : null;
  }

  daten.quizAntworten[aktuelleFrage] = antwort;
  localStorage.setItem("uniQuizDaten", JSON.stringify(daten));
}
    zurueck.addEventListener("click", () => {
      speichereAntwort();
      if (aktuelleFrage > 0) {
        aktuelleFrage--;
        zeigeFrage();
      }
    });

    weiter.addEventListener("click", () => {
      speichereAntwort();
      if (aktuelleFrage < fragen.length - 1) {
        aktuelleFrage++;
        zeigeFrage();
      }
    });

    abschliessen.addEventListener("click", () => {
      speichereAntwort(); // Letzte Antwort sichern
      frageContainer.classList.add("hidden");
      document.querySelector(".navigation").classList.add("hidden");
      dankeContainer.classList.remove("hidden");
    });

    //CSV Download mit Einverständnis
    document.getElementById("csvDownloadBtn").addEventListener("click", () => {
      const quizData = JSON.parse(localStorage.getItem("uniQuizDaten")) || {};
      const antworten = quizData.quizAntworten || [];

      const csvHeaders = [
        "consent",
        "A_R",
        "A_V(s)",
        "A_C",
        "D_R",
        "D_V(s)",
        "D_C",
        ...antworten.map((_, i) => `Frage ${i + 1}`),
        "Pseudonym" //Pseudonym am Ende falls Sonderzeichen nächste Spalte etc.
      ];

      const csvRow = [
        "true", // true consent 
        quizData.agbGelesen || false,
        quizData.agbVerweildauer || 0,
        quizData.agbAkzeptiertAm || "",
        quizData.datenschutzGelesen || false,
        quizData.datenschutzVerweildauer || 0,
        quizData.datenschutzAkzeptiertAm || "",
        ...antworten.map(a => Array.isArray(a) ? a.join(" | ") : a),
        quizData.kuerzel || "" 
        
      ];

      const csvContent = [csvHeaders.join(","), csvRow.join(",")].join("\n");

      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      const rawKuerzel = quizData.kuerzel || "user";
      const safeKuerzel = rawKuerzel.replace(/[^a-zA-Z0-9_-]/g, "_"); // ersetzt Sonderzeichen durch _
      link.setAttribute("href", url);
      link.setAttribute("download", `quiz_ergebnis_${safeKuerzel}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });

    //CSV Download ohne Einverständnis zur Datenverbeitung
    document.getElementById("csvDownloadNoConsentBtn").addEventListener("click", () => {
      const quizData = JSON.parse(localStorage.getItem("uniQuizDaten")) || {};
      const antworten = quizData.quizAntworten || [];
    
      const csvHeaders = [
        "consent",
        "A_R",
        "A_V(s)",
        "A_C",
        "D_R",
        "D_V(s)",
        "D_C",
        ...antworten.map((_, i) => `Frage ${i + 1}`),
        "Pseudonym"
      ];
    
      const csvRow = [
        "false", // consent = false
        quizData.agbGelesen || false,
        quizData.agbVerweildauer || 0,
        quizData.agbAkzeptiertAm || "",
        quizData.datenschutzGelesen || false,
        quizData.datenschutzVerweildauer || 0,
        quizData.datenschutzAkzeptiertAm || "",
        ...antworten.map(a => Array.isArray(a) ? a.join(" | ") : a),
        quizData.kuerzel || ""
      ];
    
      const csvContent = [csvHeaders.join(","), csvRow.join(",")].join("\n");
    
      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      const rawKuerzel = quizData.kuerzel || "user";
      const safeKuerzel = rawKuerzel.replace(/[^a-zA-Z0-9_-]/g, "_");
      link.setAttribute("href", url);
      link.setAttribute("download", `quiz_ergebnis_${safeKuerzel}_noConsent.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });

    // Start: erste Frage anzeigen
    document.addEventListener("DOMContentLoaded", zeigeFrage);
  </script>
</body>
</html>
